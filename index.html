<!DOCTYPE html>
<meta charset="UTF-8">

<html>
  <head>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: "Arial";
        }
        #vcenter {
            top:50%;
            left:50%;
            height:300px;
            width:1800px;
            position: absolute;
            margin: -150px 0 0 -900px;
        }
        #vcenter h1 {
            margin:auto;
            line-height:300px;
            vertical-align:middle;
            text-align: center;
            font-size: 180px;
        }

      .on {
        opacity: 1;
        transition: opacity 0.1s;
        -ms-transition: opacity 0.1s;
        -moz-transition: opacity 0.1s;
        -webkit-transition: opacity 0.1s;
      }
      .off {
        opacity: 0;
      }

    </style>
  </head>
  <body>
      <div id="vcenter">
          <h1 id="word">begin</h1>
      </div>
      <div id="pause-status">
      </div>
  </body>
  <script src="speechDetector.js">
  </script>
  <script>

    var words = ["eat", "Ed", "add"];
    var log = {startTime: new Date().getTime(), trials: [], pauses: []};
    if (window.location.hash.length > 3){
      words = window.location.hash.slice(1).split(",");
    }
    
    var INTERTRIAL_DUR_MS = 500;
    var TRIALS_PER_BLOCK = 30;
    var state = {};
    
    updateState({
      trials: [],
      currentWord: "begin",
      isPaused: false,
      isBreak: false,
      readyToAdvance: true
    });
    
    speechDetector(200 /*vol*/,
                   150 /*utterance min length ms*/,
                   75 /*post-utt silence min length ms*/,
                   detectedUtterance)
                   
    // updateState({isPaused: false})
    function updateState(newState){
       Object.keys(newState).forEach(function(k){state[k]=newState[k]});
       renderScreen(state);
    }
    
    function renderScreen(state){
    console.log("Rendering", state);
       document.getElementById("pause-status").innerHTML = state.isPaused ? "[ paused ]" : "";
       var text = "";
       var textClass = "on";
       if (state.isBreak) {
          text = "[break time]";
       } else {
          text = state.currentWord;
          textClass =  state.currentWord ? "on" : "off";
       }
       document.getElementById("word").innerHTML = text;
       document.getElementById("word").className = textClass
    }
    
    window.addEventListener("keydown",handleKeydown)
    
    function startTrial(e) {
       updateState({
          trials: state.trials.concat({
            word: state.currentWord,
            startTime: state.currentWordStartTime
          }),
          currentWord: getNextWord(),
          currentWordStartTime: now()
       })
    }
    
    function needBreak(state){
      return state.trials.length > 0 && state.trials.length%TRIALS_PER_BLOCK === 0;
    }
    
    function endTrial(e) {
       updateState({
          currentWord: null
       })
       // TODO: log it!
       
       setTimeout(function(){
         if (needBreak(state)){
            startBreak(e);
         } else {
            startTrial(e)
         }
       }, INTERTRIAL_DUR_MS);      
    }
    
    function startBreak(e) {
       updateState({
          isBreak: true,
          isPaused: true
       });
    }
    
    function detectedUtterance(uttStartTime,uttDuration) {
       if (state.trials.length>0 && !state.currentWord){
          return;
       }
       if (state.isPaused) {
          return;
       }
       if (uttStartTime < state.currentWordStartTime){
          return;
       }
       endTrial({
          source: "mic",
          uttStartTime: uttStartTime,
          uttDuration: uttDuration
       });
    }

    function getNextWord(){
      var count = state.trials.length;
      if (count < words.length) {	// loop through experiment word list
        return words[count]
      } else {                      // or pick random word
        return words[Math.floor((Math.random() * words.length))]
      }
    }
    
    function handleKeydown(e){
      if (e.code == "Space") {
        e.preventDefault();
        if (state.isBreak){
          updateState({
            isBreak : false,
            isPaused : false
          })
          startTrial();
        } else {
          updateState({isPaused : !state.isPaused})
        }
      } else if (e.code == "ArrowRight") {
        e.preventDefault();
        updateState({
            isBreak : false
        })
        endTrial()
        return false;
      } else if (e.code == "KeyL") {
        displayLog();
      }
    }
        
    function displayLog(){
       window.open('data:application/json;' + 'base64,'+btoa(JSON.stringify(log,null,2)));
    }

    function now(){
       return new Date().getTime();
    }

  </script>